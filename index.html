<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta http-equiv="CONTENT-TYPE" content="text/html; charset=utf-8">
        <title>WebGazer デモ</title>
    </head>
    <body>
        <video id="video" width="720" height="560" autoplay muted></video><br>
        <p id="err">エラーなし</p>
        <p id="p_x">X</p><br>
        <p id="p_y">Y</p><br>

        <script type="text/javascript" src="webgazer.js"></script>
        <script>
            const txt_x = document.getElementById("p_x");
            const txt_y = document.getElementById("p_y");
            const txt_err = document.getElementById('err');
            const player = document.getElementById('video');

            /**カメラを用いたビデオストリーミング**/
            function startVideo() {
                var constraints = {
                    audio: true,
                    video: {
                    width: player.width,
                    height: player.height
                    }
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    player.srcObject = stream;
                    player.onloadedmetadata = function(e) {
                    player.play();
                    };
                })
                .catch(function(err) {
                    //console.log(err.name+": "+err.message);
                    txt_err.textContent = (err.name+": "+err.message);
                });
            }

            window.onload = function () {
                startVideo();
            }

            /*Promise.all([
                webgazer.begin()
            ])
            .then(startVideo)
            .catch((err) => {
                texr_err.textContent = (err.name+": "+err.message);
            })*/

            player.addEventListener('play', () => {
                setInterval(async () => {
                    var prediction = webgazer.getCurrentPrediction();
                    /*webgazer.getCurrentPrediction().then((gaze) => {
                        txt_x.textContent = JSON.stringify(gaze);
                        txt_y.textContent = gaze.x;
                    })*/
                    prediction.then((value) => {
                        txt_x.textContent = JSON.stringify(value);
                        txt_y.textContent = value.y;
                        txt_err.textContent = typeof(value);
                    })
                    //txt_x.textContent = typeof(prediction);
                    //txt_y.textContent = prediction;
                    
                }, 100)
                .catch((err) => {
                    txt_err.textContent = (err.name+": "+err.message);
                })
            })
            .catch((err) => {
                txt_err.textContent = (err.name+": "+err.message);
            })
            
            /*webgazer.setGazeListener(function(data, elapsedTime) {
                if (data == null) {
                    return;
                }
                var xprediction = data.x; //these x coordinates are relative to the viewport
                var yprediction = data.y; //these y coordinates are relative to the viewport
                //console.log(elapsedTime); //elapsed time is based on time since begin was called
                txt_x.textContent = xprediction;
            }).begin();*/
        </script>
    </body>
</html>